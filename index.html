<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pokémon TCG Pocket Sim</title>
<link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Pok%C3%A9_Ball_icon.svg/768px-Pok%C3%A9_Ball_icon.svg.png?20161023215848"/>
<style>
body {
  font-family:'Segoe UI',Arial,sans-serif;
  background:radial-gradient(circle at top,#2b2f34,#1c1f24);
  background-attachment: fixed;
  color:#e5e7eb;
  margin:0; padding:0; min-height:100vh;
  position: relative;
  overflow-x: hidden;
}

/* Subtle animated background particles */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: 
    radial-gradient(circle at 20% 30%, rgba(227, 53, 13, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(0, 116, 217, 0.1) 0%, transparent 50%);
  animation: backgroundPulse 20s ease-in-out infinite;
  pointer-events: none;
  z-index: 0;
}

@keyframes backgroundPulse {
  0%, 100% { opacity: 0.3; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.1); }
}

.container {
  position: relative;
  z-index: 1;
}
h1 {
  text-align:center; margin:0; padding:1rem 0;
  background:linear-gradient(135deg,#e3350d,#0074d9);
  color:#fff; font-weight:600;
}
.container {
  display:flex; justify-content:space-between;
  align-items:flex-start; gap:1rem; padding:1rem;
}
.player {
  flex:1;
  background:#2a2f36;
  border-radius:12px;
  padding:1rem;
  box-shadow:0 0 8px rgba(0,0,0,0.5);
}
.player h2 {
  margin-top:0; text-align:center; color:#facc15;
}
textarea {
  width:100%; height:160px;
  background:#1e2227; color:#e5e7eb;
  border:1px solid #3f444b; border-radius:8px;
  padding:6px; font-family:monospace;
  resize:vertical;
}
button, #startBattle {
  display:block;
  margin:0.75rem auto;
  padding:8px 16px;
  background:linear-gradient(135deg,#e3350d,#0074d9);
  border:none; color:white; border-radius:8px;
  font-weight:600; cursor:pointer;
  transition:transform 0.15s ease, box-shadow 0.15s ease;
  position:relative; overflow:hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transform: translateY(0) scale(1);
}

button:hover, #startBattle:hover {
  transform:scale(1.05) translateY(-2px);
  box-shadow:0 8px 20px rgba(0,116,217,0.6),0 8px 20px rgba(227,53,13,0.6), 0 0 30px rgba(255,255,255,0.1);
}

button:active, #startBattle:active {
  transform:scale(0.98) translateY(-1px);
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}

button::before, #startBattle::before {
  content:""; position:absolute; top:0; left:0; right:0; bottom:0;
  background:linear-gradient(135deg,#e3350d,#0074d9);
  filter:blur(8px); opacity:0; transition:opacity .3s ease-in-out;
  z-index:-1;
}
button:hover::before, #startBattle:hover::before { opacity:0.6; }

/* Ripple effect on click */
button::after, #startBattle::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.4s ease-out, height 0.4s ease-out, opacity 0.4s ease-out;
  opacity: 0;
  pointer-events: none;
}

button:active::after, #startBattle:active::after {
  width: 300px;
  height: 300px;
  opacity: 1;
}

.status-line { 
  text-align:center; 
  font-size:14px; 
  margin:6px 0;
  transition: all 0.3s ease;
  animation: slideInStatus 0.3s ease;
}
@keyframes slideInStatus {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.status-ok { 
  color:#22c55e;
  text-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
}
.status-warn { 
  color:#f87171;
  text-shadow: 0 0 8px rgba(248, 113, 113, 0.5);
  animation: warnPulse 2s ease-in-out infinite;
}
@keyframes warnPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

@keyframes successPulse {
  0% { transform: scale(0.8); opacity: 0; }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); opacity: 1; }
}
.deckContainer {
  display:flex; flex-wrap:wrap; justify-content:center;
  gap:10px; margin-top:10px;
}
.card {
  width:100px; text-align:center; background:#1e2227;
  border-radius:10px; box-shadow:0 0 6px rgba(0,0,0,0.4);
  padding:6px;
}
.card img { width:100%; border-radius:6px; }
.hint { font-size:12px; color:#9ca3af; }
#startBattle {
  padding:12px 20px; font-size:16px;
  border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.5);
}
details.unparsed summary {cursor:pointer;color:#93c5fd;}

/* Card fade-in animation */
@keyframes fadeInCard {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Enhanced card hover effects */
.card {
  transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
}

.card:hover {
  transform: translateY(-4px) scale(1.05);
  box-shadow: 0 8px 16px rgba(0, 212, 255, 0.3), 0 0 20px rgba(227, 53, 13, 0.2);
  filter: brightness(1.1);
}

/* Loading skeleton */
.card-skeleton {
  width: 100px;
  height: 140px;
  background: linear-gradient(90deg, #1e2227 25%, #2a2f36 50%, #1e2227 75%);
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s ease-in-out infinite;
  border-radius: 10px;
}

@keyframes skeleton-loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* energy selector grid */
.energy-grid {
  display: grid;
  grid-template-columns: repeat(4, 40px); /* 4 per row */
  justify-content: center;
  gap: 12px 16px; /* row and column spacing */
  margin-top: 8px;
}

.energy-pip {
  width:36px; height:36px;
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  background:#1e2227;
  border:2px solid transparent;
  transition:all .2s ease;
  position: relative;
}
.energy-pip:hover { 
  transform:scale(1.15); 
  background:#2a2f36;
  box-shadow: 0 0 12px rgba(250, 204, 21, 0.4);
}
.energy-pip.selected { 
  border:2px solid #facc15; 
  box-shadow:0 0 12px #facc15, 0 0 20px rgba(250, 204, 21, 0.5);
  background: rgba(250, 204, 21, 0.1);
  animation: energyPulse 2s ease-in-out infinite;
}
@keyframes energyPulse {
  0%, 100% { box-shadow: 0 0 12px #facc15, 0 0 20px rgba(250, 204, 21, 0.5); }
  50% { box-shadow: 0 0 16px #facc15, 0 0 30px rgba(250, 204, 21, 0.7); }
}
.energy-pip img { width:26px; height:26px; pointer-events:none; transition: transform 0.2s ease; }
.energy-pip:hover img { transform: rotate(10deg); }
</style>
</head>
<body>
<h1>Pokémon TCG Pocket Sim</h1>

<div class="container">
  <div class="player" id="player1">
    <h2>Player 1</h2>
    <textarea id="deckInput1" placeholder="Paste Player 1 decklist here...">2 Froakie B1 71
2 Greninja A1 89
1 Greninja ex B1 73
2 Suicune ex A4a 20
1 Indeedee ex B1 121

2 Professor's Research P-A 7
2 Cyrus A2 150
1 Copycat B1 225
1 Mars A2 155
1 Irida A2a 72
2 Rare Candy A3 144
2 Poké Ball P-A 5
1 Giant Cape A2 147

Energy: Water</textarea>
    <div class="energy-wrap">
      <label><strong>Energy Types (max 3)</strong></label>
      <div class="energy-grid" id="energyGrid1"></div>
      <div class="hint">Click to toggle up to three energy types.</div>
    </div>
    <button id="parseBtn1">Load Deck</button>
    <div id="status1" class="loading"></div>
    <div id="count1" class="status-line"></div>
    <details id="unparsed1" class="unparsed" hidden>
      <summary>Unparsed lines</summary>
      <ul id="unparsedList1"></ul>
    </details>
    <div id="deckContainer1" class="deckContainer"></div>
  </div>

  <div class="player" id="player2">
    <h2>Player 2</h2>
    <textarea id="deckInput2" placeholder="Paste Player 2 decklist here...">2 Eevee B1 184
2 Jolteon ex B1 81
1 Jolteon A3b 25
1 Sylveon ex A3b 34
2 Eevee ex A3b 56
1 Oricorio A3 66

2 Professor's Research P-A 7
1 Sabrina A1 225
1 Red A2b 71
1 Mars A2 155
1 Cyrus A2 150
1 Copycat B1 225
2 Poké Ball P-A 5
1 X Speed P-A 2
1 Giant Cape A2 147</textarea>
    <div class="energy-wrap">
      <label><strong>Energy Types (max 3)</strong></label>
      <div class="energy-grid" id="energyGrid2"></div>
      <div class="hint">Click to toggle up to three energy types.</div>
    </div>
    <button id="parseBtn2">Load Deck</button>
    <div id="status2" class="loading"></div>
    <div id="count2" class="status-line"></div>
    <details id="unparsed2" class="unparsed" hidden>
      <summary>Unparsed lines</summary>
      <ul id="unparsedList2"></ul>
    </details>
    <div id="deckContainer2" class="deckContainer"></div>
  </div>
</div>

  <div style="text-align: center; margin: 1rem 0;">
  <button id="startBattle">Start Battle</button>
  <button id="handTester" style="margin-left: 1rem;">Opening Hand Tester</button>
</div>

<script type="module">
import { parseDecklist, fetchCardData, loadPocketSets } from './deckparser.js';

/* --- Energy pips --- */
const ENERGY_ICONS={
  fire:'https://archives.bulbagarden.net/media/upload/thumb/a/ad/Fire-attack.png/20px-Fire-attack.png',
  water:'https://archives.bulbagarden.net/media/upload/thumb/1/11/Water-attack.png/20px-Water-attack.png',
  grass:'https://archives.bulbagarden.net/media/upload/thumb/2/2e/Grass-attack.png/20px-Grass-attack.png',
  lightning:'https://archives.bulbagarden.net/media/upload/thumb/0/04/Lightning-attack.png/20px-Lightning-attack.png',
  psychic:'https://archives.bulbagarden.net/media/upload/thumb/e/ef/Psychic-attack.png/20px-Psychic-attack.png',
  fighting:'https://archives.bulbagarden.net/media/upload/thumb/4/48/Fighting-attack.png/20px-Fighting-attack.png',
  darkness:'https://archives.bulbagarden.net/media/upload/thumb/a/ab/Darkness-attack.png/20px-Darkness-attack.png',
  metal:'https://archives.bulbagarden.net/media/upload/thumb/6/64/Metal-attack.png/20px-Metal-attack.png',
};
const MAX_ENERGIES=3;

function initEnergyGrid(gridId){
  const grid=document.getElementById(gridId);
  Object.entries(ENERGY_ICONS).forEach(([type,url])=>{
    const div=document.createElement('div');
    div.className='energy-pip';
    div.dataset.type=type;
    div.innerHTML=`<img src="${url}" alt="${type}">`;
    grid.appendChild(div);
  });
  grid.addEventListener('click',e=>{
    const pip=e.target.closest('.energy-pip');
    if(!pip)return;
    const selected=[...grid.querySelectorAll('.energy-pip.selected')];
    if(pip.classList.contains('selected')){pip.classList.remove('selected');return;}
    if(selected.length>=MAX_ENERGIES){alert(`You can select up to ${MAX_ENERGIES} energy types.`);return;}
    pip.classList.add('selected');
  });
}
function attachEnergySave(gridId, playerNum) {
  const grid = document.getElementById(gridId);
  grid.addEventListener('click', () => {
    const selected = getSelectedEnergies(gridId);
    localStorage.setItem(`player${playerNum}Energy`, JSON.stringify(selected));
  });
}

attachEnergySave('energyGrid1', 1);
attachEnergySave('energyGrid2', 2);

function getSelectedEnergies(gridId){
  return [...document.querySelectorAll(`#${gridId} .energy-pip.selected`)]
    .map(d=>d.dataset.type);
}
initEnergyGrid('energyGrid1');
initEnergyGrid('energyGrid2');

/* --- Deck parsing --- */
async function loadDeck(num){
  const area=document.getElementById(`player${num}`);
  const textArea=area.querySelector('textarea');
  const status=area.querySelector('.loading');
  const container=area.querySelector('.deckContainer');
  const countLine=area.querySelector('.status-line');
  const unparsedBox=area.querySelector('details');
  const unparsedList=area.querySelector('ul');

  container.innerHTML=''; countLine.textContent='';
  unparsedList.innerHTML=''; unparsedBox.hidden=true;
  status.textContent='Loading deck...';
  await loadPocketSets();

let text = textArea.value.trim();

// detect Energy: line like "Energy: Water" or multiple separated by commas
const energyMatch = text.match(/^\s*Energy:\s*(.+)$/im);
if (energyMatch) {
  const raw = energyMatch[1].split(/[,/]/).map(w => w.trim().toLowerCase());
  const valid = Object.keys(ENERGY_ICONS);
  const chosen = raw.filter(w => valid.includes(w)).slice(0, MAX_ENERGIES);

  // auto-select matching pips visually
  const grid = document.getElementById(`energyGrid${num}`);
  [...grid.querySelectorAll('.energy-pip')].forEach(p => {
    p.classList.toggle('selected', chosen.includes(p.dataset.type));
  });

  // save immediately for Start Battle use
  localStorage.setItem(`player${num}Energy`, JSON.stringify(chosen));

  // remove that line from the deck text before parsing
  text = text.replace(/^\s*Energy:\s*.+$/im, '').trim();
}

  const parsed=parseDecklist(text);
  if(!parsed.length){status.textContent='No valid cards found.';return;}

  // Fetch all cards in parallel for better performance
  const totalCards = parsed.length;
  status.textContent = `Loading 0/${totalCards} cards...`;
  
  const fetchPromises = parsed.map(c => fetchCardData(c));
  const results = await Promise.all(fetchPromises);
  
  const fetched = [];
  for(let i = 0; i < results.length; i++) {
    const card = results[i];
    if(card && card.name) {
      card.quantity = Number(parsed[i].quantity) || 1;
      fetched.push(card);
    }
    // Update progress
    status.textContent = `Loading ${i + 1}/${totalCards} cards...`;
  }

  status.textContent='';
  
  // Render cards with fade-in animation
  container.innerHTML = fetched.map((c, idx) => `
    <div class="card" style="opacity: 0; animation: fadeInCard 0.3s ease forwards; animation-delay: ${idx * 0.05}s;">
      ${c.image?`<img src="${c.image}" alt="${c.name}" loading="lazy">`:'<div>No image</div>'}
      <div><strong>${c.quantity}×</strong> ${c.name}</div>
      <div>${c.set}-${c.number}</div>
    </div>`).join('');

  const total=fetched.reduce((s,c)=>s+(c.quantity||0),0);
  if(total===20){countLine.textContent='Total cards parsed: 20';countLine.className='status-line status-ok';}
  else{countLine.textContent=`Total cards parsed: ${total} (expected 20)`;countLine.className='status-line status-warn';}

  localStorage.setItem(`player${num}Deck`,JSON.stringify(fetched));
  const energies=getSelectedEnergies(`energyGrid${num}`);
  localStorage.setItem(`player${num}Energy`,JSON.stringify(energies));
  
  // Animate success message
  status.textContent='✓ Deck ready!';
  status.style.color = '#22c55e';
  status.style.animation = 'successPulse 0.5s ease';
  setTimeout(() => {
    status.textContent = '';
    status.style.color = '';
    status.style.animation = '';
  }, 2000);
}

document.getElementById('parseBtn1').onclick=()=>loadDeck(1);
document.getElementById('parseBtn2').onclick=()=>loadDeck(2);

document.getElementById('startBattle').onclick=()=>{
  const p1=JSON.parse(localStorage.getItem('player1Deck')||'[]');
  const p2=JSON.parse(localStorage.getItem('player2Deck')||'[]');
  const e1=JSON.parse(localStorage.getItem('player1Energy')||'[]');
  const e2=JSON.parse(localStorage.getItem('player2Energy')||'[]');
  const count=a=>a.reduce((s,c)=>s+(c.quantity||0),0);

  if(!p1.length||!p2.length){alert('Both decks must be loaded first.');return;}
  if(!e1.length||!e2.length){alert('Select at least one energy type for each player.');return;}
  if(count(p1)!==20||count(p2)!==20){alert(`Each deck must total 20 cards. Current: P1=${count(p1)}, P2=${count(p2)}`);return;}

  window.location.href='battle.html';
};

document.getElementById('handTester').onclick=()=>{
  window.location.href='hand-tester.html';
};

// Pre-load Pocket sets on page load for better performance
window.addEventListener('DOMContentLoaded', async () => {
  // Pre-load sets in background
  loadPocketSets().catch(err => console.warn('Failed to pre-load Pocket sets:', err));
  
  ['1','2'].forEach(num => {
    const saved = JSON.parse(localStorage.getItem(`player${num}Energy`) || '[]');
    const grid = document.getElementById(`energyGrid${num}`);
    saved.forEach(t => {
      const pip = grid.querySelector(`.energy-pip[data-type="${t}"]`);
      if (pip) pip.classList.add('selected');
    });
  });
});

</script>
</body>
</html>